---
title: "Epigraphic formula `Dis manibus` in space and time"
author: "Petra Hermankova"
date: "24/08/2021"
output:
  html_document:
    theme: united
    toc: yes
    toc_float: true
    number_sections: true
    toc_depth: 2
    df_print: paged
---

```{r}
#install.packages(c("reticulate", "stringdist", "ape", "igraph", "tidyverse", "reticulate", "jsonlite", "leaflet"))    

library(igraph)
library(ape)
library(stringdist)
library(tidyverse)
library(reticulate)
library(jsonlite)
library(leaflet)
#use_python("/usr/local/bin/python/") # use this if you have local python installed
#use_condaenv("pip")

Sys.which("python") # checks which python do I use
```
Sources: # http://amunategui.github.io/stringdist/

```{python}
# installation of packages is recommended to do via the terminal (see in your console below), pip install name-of-the-required-package

# https://vincent.doba.fr/posts/20210407_install-fiona-on-windows/ & https://geopandas.org/getting_started/install.html Issues with geopandas on windows

#to install requirements type and run in the terminal:  pip install -r requirements.txt

import fiona
import geopandas as gpd 
import requests
import seaborn as sns
import matplotlib.colors as mcolors
import matplotlib.pyplot as plt
from scipy.stats import trapz
import scipy
#import nltk
import json
import tempun
#import sddk
import numpy as np
import pandas as pd
pd.options.display.max_columns = 1000  # to see all columns
```


## Loading data from Sciencedata.dk

```{r}
#list_json <- jsonlite::fromJSON("https://sciencedata.dk/public/b6b6afdb969d378b70929e86e58ad975/EDH_text_cleaned_2021-01-21.json")
#EDH <- as_tibble(list_json)
```

## Loading data locally
```{r}
# this will work only if you have the dataset available locally
EDH <- jsonlite::fromJSON("../data/EDH_text_cleaned_2021-01-21.json")
#dir.create("../figures")
```

## Text preparation

Converting the text of inscriptions to lowercase
```{r}
EDH <- EDH %>% 
  mutate(clean_text_interpretive_word_lowercase = str_to_lower(EDH$clean_text_interpretive_word)) %>% 
  mutate(clean_text_conservative_lowercase = str_to_lower(EDH$clean_text_conservative))


```

## Preparation coordinates for mapping
```{r}
# preparation of coordinates
EDH<- EDH %>% 
  separate(col = coordinates, into = c("longitude", "latitude"), sep = ",")

EDH$latitude <- as.numeric(str_replace(EDH$latitude, pattern = "\\)", replacement=""))
EDH$longitude <- as.numeric(str_replace(EDH$longitude, pattern = "c\\(", replacement=""))
```


# Dis Manibus epigraphic formula in space and time

Typically occurs on funerary inscriptions, invocation of the underworld gods.

Canonic Versions:

D M - only in the conservative version of the text
D M S -  only in the conservative version 
Dis Manibus
Diis Manibus
Dis Manibus Sacrum
Diis Manibus Sacrum

## Searching for all *typical* variants of the formula

```{r}
dis_manibus_regex_minimal <- "di{1,2}s manibus sacrum|di{1,2}s manibus"
dis_manibus_regex_maximal <- "\\bd m s\\b|\\bd m\\b|di{1,2}s manibus sacrum|di{1,2}s manibus|\\bdi{1,2} man[e|i]s\\b"

dis_manibus_int<- str_subset(EDH$clean_text_interpretive_word_lowercase, dis_manibus_regex_minimal)

dis_manibus_cons<- str_subset(EDH$clean_text_conservative_lowercase, dis_manibus_regex_maximal)


# separating them in a new attribute
EDH<- EDH %>% 
  mutate(form_dis_manibus_ins = str_extract(EDH$clean_text_interpretive_word_lowercase, dis_manibus_regex_minimal)) %>% 
  mutate(form_dis_manibus_cons = str_extract(EDH$clean_text_conservative_lowercase, dis_manibus_regex_maximal)) 

EDH$form_dis_manibus <- ifelse(grepl("\\w", EDH$form_dis_manibus_ins, ignore.case = T),  EDH$form_dis_manibus_ins, EDH$form_dis_manibus_cons)

EDH$form_dis_manibus <- ifelse(grepl("d m s", EDH$form_dis_manibus, ignore.case = T),  "dis manibus sacrum", 
                               ifelse(grepl("d m", EDH$form_dis_manibus, ignore.case = T),  "dis manibus",
                               EDH$form_dis_manibus))

table(EDH$form_dis_manibus)  

# overview
table(str_extract(EDH$clean_text_interpretive_word_lowercase, dis_manibus_regex_minimal))

table(str_extract(EDH$clean_text_conservative_lowercase, dis_manibus_regex_maximal))
```

```{r}
# capturing context - 5 words before the formula and 5 words after the formula
#EDH<- EDH %>% 
#  mutate(dis_manibus_in_context_10w = str_extract(EDH$clean_text_interpretive_word_lowercase, "(\\w*\\s){0,6}di{1,2}s manibus sacrum|di{1,2}s manibus(\\w*\\s){0,6}")) 
```

Subsetting dataset to contain only records with formula
```{r}
#non-empty dis manibus attribute
EDH_DM <- EDH %>% 
  filter(!is.na(form_dis_manibus))
```



Save the dataset locally
```{r}
EDH_DMjson <- toJSON(EDH_DM, simplifyVector = TRUE)
write(EDH_DMjson, "../data/EDH_DM.json")
```

## Ratio of inscriptions with DM formula

```{r}
nrow(EDH %>% 
  filter(!is.na(form_dis_manibus)))/(nrow(EDH)/100)
```

## Type of all inscription with DM formula
```{r}
EDH_DM %>% 
  count(type_of_inscription_clean, sort = T) %>% 
  mutate(ratio = round(n/(sum(n)/100),2))
```

## Ratio of funerary inscriptions with DM formula

```{r}
epitaph_all<- length(EDH$type_of_inscription_clean[EDH$type_of_inscription_clean == "epitaph"])
epitaph_dm<- length(EDH_DM$type_of_inscription_clean[EDH_DM$type_of_inscription_clean == "epitaph"])

epitaph_dm/(epitaph_all/100)
```
## Type of the formula overall

```{r}
form_dm<- EDH_DM %>% 
  #filter(type_of_inscription_clean %in% c("epitaph", "NULL")) %>% 
  filter(!is.na(form_dis_manibus)) %>% 
  count(form_dis_manibus, sort=T) %>% 
  mutate(ratio = round(n/(sum(n)/100),2))

form_dm

write_csv(form_dm, "../output/DM_form_total_numbers.csv")
```
## Type of formula by province - frequence
```{r, fig.height=10, fig.width=14}
EDM_DM_freq<- EDH_DM %>% 
  #count(province_label_clean, form_dis_manibus, sort=T) %>% 
  ggplot(aes(y=province_label_clean)) + 
  geom_bar(aes(fill=form_dis_manibus)) +
  #coord_cartesian(xlim=c(0,1700)) +
  theme_minimal() +
  theme(text = element_text(size=12)) +
  labs(y="Roman province", x="Formula", title= "Frequence of Dis Manibus formula by province", subtitle = ggtitle(paste("n =", nrow(EDH_DM), "inscriptions (EDH)")))  
ggsave("../figures/EDM_DM_province_freq.png")
EDM_DM_freq
```
## Ratio of DM variants per province
```{r, fig.height=10}

DM_form<- EDH_DM %>% 
  select(form_dis_manibus, province_label_clean) %>% 
  count(form_dis_manibus, province_label_clean, sort=T)


EDH_DM %>% 
  ggplot(aes(y=province_label_clean, fill=form_dis_manibus)) +
  geom_bar(position="fill") +
  theme_minimal() +
  theme(text = element_text(size=12)) +
  geom_vline(xintercept=c(0.25, 0.5, 0.75), linetype="dotted", color = "blue", size=0.8) + 
  labs(y="Roman province", x="Formula", title= "Ratio of Dis Manibus formulae by province", subtitle = ggtitle(paste("n =", nrow(EDH_DM), "inscriptions (EDH)"))) 
  #geom_label(aes(label= form_dis_manibus)) +
  #geom_label(aes(label = form_dis_manibus), colour = "black", fontface = "bold", hjust = -0.1)
```
Provinces with Dis manibus sacrum
```{r, fig.height=7}

EDH_DM$province_label_clean <-factor(EDH_DM$province_label_clean)

EDH_DM$form_dis_manibus <-factor(EDH_DM$form_dis_manibus)


EDH_DM %>% 
  count(form_dis_manibus, province_label_clean, sort=T) %>% 
  group_by(form_dis_manibus) %>%  
  filter(form_dis_manibus == "dis manibus sacrum") %>% 
  ggplot(aes(y=fct_reorder(province_label_clean, n), x=n)) +
  geom_col(fill= "blue") +
  labs(y="Roman province", x="n", title= "Frequence of 'Dis Manibus Sacrum' formula by province", subtitle = ggtitle(paste("n =", nrow(EDH_DM), "inscriptions (EDH)"))) +
  geom_text(aes(label = n), colour = "black", size= 3, hjust = -0.1)

```

```{r, fig.height=7}
EDH_DM %>% 
  count(form_dis_manibus, province_label_clean, sort=T) %>% 
  group_by(form_dis_manibus) %>%  
  filter(form_dis_manibus == "dis manibus") %>% 
  ggplot(aes(y=fct_reorder(province_label_clean, n), x=n)) +
  geom_col(fill= "blue") +
  labs(y="Roman province", x="n", title= "Frequence of 'Dis Manibus' formula by province", subtitle = ggtitle(paste("n =", nrow(EDH_DM), "inscriptions (EDH)"))) +
  geom_text(aes(label = n), colour = "black", size= 3, hjust = -0.1)
```

### Ratio of formulae per province normalized by the number of total inscriptions

```{r}

DM_form_province<- EDH_DM %>% 
  count(form_dis_manibus, province_label_clean, sort=T) %>% 
  pivot_wider(names_from = form_dis_manibus, values_from = n)

province_total_insc<- EDH %>% 
  count(province_label_clean)

provinces_DM<- merge(x=province_total_insc, y=DM_form_province, by="province_label_clean", all=T)

provinces_DM<- provinces_DM %>% 
  rename(all_insc=n)

provinces_DM <- provinces_DM %>% 
  mutate(dm = provinces_DM$`dis manibus`+provinces_DM$`diis manibus`) %>% 
  mutate(dms = provinces_DM$`dis manibus sacrum`+provinces_DM$`diis manibus sacrum`) %>% 
  mutate(dm_ratio = round(dm/(all_insc/100),2)) %>% 
  mutate(dms_ratio = round(dms/(all_insc/100),2))

provinces_DM
write_csv(provinces_DM, "../output/DM_form_provinces.csv")
```

How common the dm and the dms formulae are (of all inscriptions from a given province)

```{r, fig.height=7}
#Filter those provinces where the ratio is higher than mean for all provinces fro a given formula

higher_dm<- provinces_DM %>% 
    filter(dm_ratio > mean(na.omit(provinces_DM$dm_ratio)))
higher_dm

```
```{r}
higher_dms<- provinces_DM %>% 
    filter(dms_ratio > mean(na.omit(provinces_DM$dms_ratio)))
higher_dms
```

```{r}
higher_dm_dms<- provinces_DM %>% 
    filter(dm_ratio > mean(na.omit(provinces_DM$dm_ratio)& dms_ratio > mean(na.omit(provinces_DM$dms_ratio))))
higher_dm_dms
```



## Map of Dis Manibus occurences - cummulative
```{r}
# preparation of subsets
# dis manibus formula
EDH_dis_manibus <- EDH_DM %>% 
  filter(form_dis_manibus == "dis manibus")

# diis manibus formula
EDH_diis_manibus <- EDH_DM %>% 
  filter(form_dis_manibus == "diis manibus")

# dis manibus sacrum formula
EDH_dis_manibus_sacrum <- EDH_DM %>% 
  filter(form_dis_manibus == "dis manibus sacrum")

# diis manibus sacrum formula
EDH_diis_manibus_sacrum <- EDH_DM %>% 
  filter(form_dis_manibus == "diis manibus sacrum")

```


```{r}
DM_map<- #head(EDH_DM, 100) %>% 
  leaflet(EDH_DM) %>% 
  leaflet(width="100%") %>%
  #addProviderTiles("Stamen.Watercolor")%>% # Add CartoDB map tiles
  addProviderTiles("Stamen.TerrainBackground")%>% # Add CartoDB map tiles
  #addProviderTiles("Esri.WorldTopoMap", group = "Topo") %>%
  #addProviderTiles("Esri.WorldImagery", group = "ESRI Aerial") %>%
  setView( lng = 12.9239625, lat = 41.9515694, zoom = 3.5 ) %>%
  #setMaxBounds(lat1=43.633977, lng1 =-11.227926 , lat2=35.133882 , lng2=50.882336) %>%
  #addPolylines(data = roads, color = "purple", weight = 1, opacity = 0.7) %>% 
  
  addCircles(lng = EDH_dis_manibus$longitude, 
             lat = EDH_dis_manibus$latitude, opacity = 0.3, radius = 0.7, fill = T , color = "blue" , fillColor = "blue",) %>%
  addCircles(lng = EDH_dis_manibus_sacrum$longitude, 
             lat = EDH_dis_manibus_sacrum$latitude, opacity = 0.3, radius = 0.7, fill = T , color = "red" , fillColor = "red",) %>%
    addCircles(lng = EDH_diis_manibus$longitude, 
             lat = EDH_diis_manibus$latitude, opacity = 0.3, radius = 0.7, fill = T , color = "black" , fillColor = "black",) %>%
  addCircles(lng = EDH_diis_manibus_sacrum$longitude, 
             lat = EDH_diis_manibus_sacrum$latitude, opacity = 0.3, radius = 0.7, fill = T , color = "orange" , fillColor = "orange",) %>%
  

  #addAwesomeMarkers(~EDH$longitude, ~EDH$latitude, icon=icons) %>% 
  addLegend(position = "bottomright",
  colors = c("Blue", "Green", "Red", "Orange"),
  labels = c("dis manibus", "diis manibus", "dis manibus sacrum", "diis manibus sacrum"), opacity = 1,
  title = "Dis Manibus formula (EDH)" 
) %>% 
  addScaleBar(position="bottomleft")

DM_map
```
```{r}
#Load in temporal data

EDH_1CAD <- fromJSON("../data/EDH_1CAD.json")
EDH_2CAD <- fromJSON("../data/EDH_2CAD.json")
EDH_3CAD <- fromJSON("../data/EDH_3CAD.json")
```

### HeatMap

```{r}
library(leaflet.extras)
library(RColorBrewer)
heat_formulae1 <- EDH_1CAD %>% 
  leaflet(width="100%") %>%
  addTiles() %>% 
  addProviderTiles("Stamen.TerrainBackground")%>%
  addProviderTiles("Stamen.TonerBackground") %>% 
  setView( lng = 12.9239625, lat = 41.9515694, zoom = 4 ) %>%
  #setMaxBounds(lat1=40.633977, lng1 =-4.227926 , lat2=35.133882 , lng2=40.882336) %>%
 
  addHeatmap(lng = ~as.numeric(na.omit(EDH_1CAD$longitude)), lat = ~as.numeric(na.omit(EDH_1CAD$latitude)), 
            intensity = 0.5, layerId = NULL, group = NULL, minOpacity = 0.5, #max = 1,
  radius = 3, blur = 2, gradient = "Reds", cellSize = 1,) %>% 
  
 
  
  addLegend(position = "topright",
  colors = c("Red", "Blue", "Green"),
  labels = c("1st c. AD", "2nd c. AD", "3rd c. AD"), opacity = 1,
  title = "Heat map of Dis Manibus formulae" 
) %>% 
  addScaleBar(position="bottomleft")

heat_formulae1
```

```{r}
heat_formulae2 <- EDH_1CAD %>% 
  leaflet(width="100%") %>%
  addTiles() %>% 
  addProviderTiles("Stamen.TerrainBackground")%>%
  addProviderTiles("Stamen.TonerBackground") %>% 
  setView( lng = 12.9239625, lat = 41.9515694, zoom = 4 ) %>%
  #setMaxBounds(lat1=40.633977, lng1 =-4.227926 , lat2=35.133882 , lng2=40.882336) %>%
 
  addHeatmap(lng = ~as.numeric(na.omit(EDH_2CAD$longitude)), lat = ~as.numeric(na.omit(EDH_2CAD$latitude)), 
            intensity = 0.5, layerId = NULL, group = NULL, minOpacity = 0.5, #max = 1,
  radius = 3, blur = 2, gradient = "Blues", cellSize = 1,
  ) %>% 
  addScaleBar(position="bottomleft")
heat_formulae2
```
```{r}
heat_formulae3 <- EDH_3CAD %>% 
  leaflet(width="100%") %>%
  addTiles() %>% 
  addProviderTiles("Stamen.TerrainBackground")%>%
  addProviderTiles("Stamen.TonerBackground") %>% 
  setView( lng = 12.9239625, lat = 41.9515694, zoom = 4 ) %>%
  #setMaxBounds(lat1=40.633977, lng1 =-4.227926 , lat2=35.133882 , lng2=40.882336) %>%
 
  addHeatmap(lng = ~as.numeric(na.omit(EDH_3CAD$longitude)), lat = ~as.numeric(na.omit(EDH_3CAD$latitude)), 
            intensity = 0.5, layerId = NULL, group = NULL, minOpacity = 0.5, #max = 1,
  radius = 3, blur = 2, gradient = "Greens", cellSize = 1,
  ) %>% 
  addScaleBar(position="bottomleft")

heat_formulae3
```


## Dis manibus formula demographic preferences - overall

Preparation of the dataset - unique people records

```{r}
EDH_small <- EDH_DM %>% 
  select(id, people, form_dis_manibus, type_of_inscription_clean, type_of_monument_clean)

EDH_smu <- EDH_small %>% unnest_wider(people)
names(EDH_smu)

EDH_people<- EDH_small %>% unnest_wider(people) %>% 
  unnest_longer(names(EDH_smu))
```

### Formula by gender of person on inscription
```{r}
EDH_gender<- EDH_people %>% 
  #filter(form_dis_manibus == "dis manibus" | form_dis_manibus == "dis manibus sacrum") %>% 
  mutate(gender_clean = str_replace_all(gender, "W\\?", "female")) %>%
  mutate(gender_clean = str_replace_all(gender_clean, "M\\?", "male"))


EDH_gender %>% 
  count(gender_clean, form_dis_manibus, sort=T) %>% 
  mutate(freq = n/(sum(n)/100)) %>% 
  ggplot(aes(y=gender_clean, x=n)) +
  geom_col(aes(fill=form_dis_manibus)) +
  #geom_label(aes(label = round(freq, 2)), hjust=0.3, size = 3.5) +
  theme_linedraw(base_size = 12) +
  labs(y="Gender", x="Formula", title= "Dis Manibus formula by gender", subtitle = ggtitle(paste("n =", length(EDH_DM$people), "inscriptions (EDH)"))) 


```
```{r}
EDH_gender %>% 
  ggplot(aes(x=gender_clean, fill=form_dis_manibus)) +
  geom_bar(position="fill") +
  #geom_label(aes(label = round(freq, 2)), hjust=0.3, size = 3.5) +
  #theme_linedraw(base_size = 12) +
  labs(y="Gender", x="Formula", title= "Ratio of Dis Manibus formula by gender", subtitle = ggtitle(paste("n =", length(EDH_DM$people), "inscriptions (EDH)")))
```


### Formula by status of person on inscription
```{r, fig.width=14, fig.height=10}

EDH_people %>% 
  #filter(form_dis_manibus == "dis manibus" | form_dis_manibus == "dis manibus sacrum") %>% 
  mutate(status_clean = str_replace_all(status, "\\?", "")) %>% 
  count(status_clean, form_dis_manibus, sort=T) %>% 
  ggplot(aes(y=status_clean, x=n)) +
  geom_col(aes(fill=form_dis_manibus)) +
  #coord_cartesian(xlim = c(0, 15800)) +
  labs(y="Status", x="Individuals", title= "Dis Manibus formula by personal status", subtitle = ggtitle(paste("n =", nrow(EDH_people), "individuals (EDH)"))) +
  theme(legend.position = c(0.9, 0.15)) +
  scale_fill_discrete(name="Formula")
```

```{r, fig.width=14, fig.height=10}

EDH_status<- EDH_people %>% 
  #filter(form_dis_manibus == "dis manibus" | form_dis_manibus == "dis manibus sacrum") %>% 
  mutate(status_clean = str_replace_all(status, "\\?", "")) 

```

Need to create the highest status category: 
1) slaves,
2) freedmen / freedwomen, 
3) Augustales,
4) military personnel, 
5) lower local offices, administration of imperial estates, 
6) decurial order, high local offices,
7) equestrian order,
8) senatorial order, 
9) rulers (foreign)


```{r}
EDH_status$status_highest <- ifelse(grepl("decurial order, higher local offices; military personnel", EDH_status$status_clean, ignore.case = T),  "decurial order, higher local offices",
                                    ifelse(grepl("equestrian order; decurial order, higher local offices", EDH_status$status_clean, ignore.case = T), "equestrian order",
                                           ifelse(grepl("senatorial order; equestrian order", EDH_status$status_clean, ignore.case = T), "senatorial order", 
                                                  ifelse(grepl("Augustales; freedmen / freedwomen", EDH_status$status_clean, ignore.case = T), "Augustales", 
                                                         ifelse(grepl("decurial order, higher local offices; Augustales", EDH_status$status_clean, ignore.case = T), "decurial order, higher local offices", 
                                                                ifelse(grepl("decurial order, higher local offices; freedmen / freedwomen", EDH_status$status_clean, ignore.case = T), "decurial order, higher local offices",
                                                                       ifelse(grepl("equestrian order; lower local offices, administration of imperial estates", EDH_status$status_clean, ignore.case = T), "equestrian order",
                                                                          
                                                  EDH_status$status_clean)))))))
```
                                    
```{r, fig.width=10, fig.height=5}

EDH_status_count <- EDH_status %>% 
  count(form_dis_manibus, status_clean, sort = T) %>% 
  mutate(ratio = round(n/(sum(n)/100),2)) 

mean_dms <- mean(EDH_status_count$ratio[EDH_status_count$form_dis_manibus == "dis manibus sacrum"])

EDH_status %>% 
  ggplot(aes(y=status_highest, fill=form_dis_manibus)) +
  geom_bar(position="fill") +
  #coord_cartesian(xlim = c(0, 15800)) +
  labs(y="Status", x="Individuals", title= "Ratio of Dis Manibus formula by personal status", subtitle = ggtitle(paste("n =", nrow(EDH_people), "individuals (EDH)"))) +
  #theme(legend.position = c(0.9, 0.15)) +
  scale_fill_discrete(name="Formula") +
  geom_vline(xintercept =mean_dms/10, linetype = "longdash", size=0.3)



  
```
### Formula by age of person on inscription
```{r}
EDH_people %>% 
  mutate(age_yr = as.numeric(`age: years`)) %>% 
  filter(!is.na(age_yr)) %>% 
  count(age_yr, form_dis_manibus, sort=T) %>% 
  ggplot(aes(age_yr, n, colour= form_dis_manibus)) +
  geom_point(aes(colour=form_dis_manibus)) +
  labs(y="Individuals", x="Years at death", title= "Dis Manibus formula by age in years of the deceased", subtitle = ggtitle(paste("n =", nrow(EDH_people), "individuals (EDH)")))+
  geom_smooth(se = FALSE, method = lm) +
  facet_wrap(~form_dis_manibus)
  
  
```
Average age per formula type / CONTINUE


```{r}
average_age <- EDH_people %>% 
  mutate(age_yr = as.numeric(`age: years`)) %>% 
  filter(!is.na(age_yr)) %>%
  select(age_yr) 

average_age_all<- mean(na.omit(average_age$age_yr))

average_age_per_formula <- EDH_people %>% 
  mutate(age_yr = as.numeric(`age: years`)) %>% 
  filter(!is.na(age_yr)) %>%
  group_by(form_dis_manibus) %>% 
  summarise_at(vars(age_yr), list(name=mean)) %>% 
  mutate(diff_av_age  =  name-average_age_all)

average_age_per_formula

```



### Formula by type of inscribed monument
```{r}
EDH_DM %>% 
  count(type_of_monument_clean, form_dis_manibus, sort = T) %>% 
  ggplot(aes(y=type_of_monument_clean, x=n)) + 
  geom_col(aes(fill=form_dis_manibus)) +
  theme_minimal() +
  labs(y="Inscribed object", x="Inscriptions", title= "Dis Manibus formula by inscribed object", subtitle = ggtitle(paste("n =", nrow(EDH_DM), "inscriptions (EDH)")))
```

### Formula by type of inscribed material
```{r}
EDH_DM %>% 
  count(material_clean, form_dis_manibus, sort = T) %>% 
  ggplot(aes(y=material_clean, x=n)) + 
  geom_col(aes(fill=form_dis_manibus)) +
  theme_minimal() +
  labs(y="Inscribed material", x="Inscriptions", title= "Dis Manibus formula by inscribed material", subtitle = ggtitle(paste("n =", nrow(EDH_DM), "inscriptions (EDH)")))
```

# Temporal usage of the formulae


```{r}
# preparation of the dataset
EDH_DM$not_before <- as.numeric(as.character(EDH_DM$not_before))
EDH_DM$not_after <- as.numeric(as.character(EDH_DM$not_after))
```

```{python}

# How many inscriptions have both dates?
EDH_dated = r.EDH_DM[(r.EDH_DM["not_before"].notnull()) | (r.EDH_DM["not_after"].notnull())]
len(EDH_dated)
```

```{python}
# Generate a list of 1000 random dates for each inscription in the dataset
EDH_dated["random_dates"] = EDH_dated.apply(lambda row: tempun.model_date(
    row["not_before"], row["not_after"], size=1000,), axis=1)
```

```{r}
# saving as r-object
py$EDH_dated -> EDH_dated
```

```{python}
# Count random dates in temporal timeblocks in a specified time range (from 200 BC to 600 AD, temporal blocks by 25 years)
EDH_complete_simulations = tempun.timeblocks_from_randoms(
    EDH_dated, "random_dates", [-200, 600, 25])
```


```{python}
# Figure 1
# plot all the dataset to see the epigraphic production in time
plt.style.use("seaborn-white")
plt.rcParams['figure.dpi'] = 300
plt.rcParams['font.size'] = 10
tab_colors_list = list(mcolors.TABLEAU_COLORS.keys())
fig, ax = plt.subplots(figsize=(14, 6), tight_layout=True)
tempun.plot_timeblocks_data(
    EDH_complete_simulations, ax=ax, color="gray", label=f"EDH (n={len(EDH_dated)})")
    
ax.set_xlabel("Year", weight="bold")
ax.set_ylabel("Count", weight="bold")
ax.set_title("Dis Manibus: Epigraphic production over time (EDH)")
ax.legend(title="Data source", title_fontsize="large", bbox_to_anchor=(1, 1), loc='upper right')
#plt.axvline(x=212, linewidth=0.5, color = 'orange', linestyle='dashed')
#fig.suptitle(f'Comparison of epigraphic production over time', fontsize=16,fontweight="bold")
fig
plt.savefig('../figures/01_EDH_Epi_production_time.png')
```


```{python}
# Inscriptions by their type over time, EDH
simulations_by_type_len_EDH = []
for ins_type in r.EDH_DM["form_dis_manibus"].unique():
    if ins_type != "NULL":
        subset_df = EDH_dated[EDH_dated["form_dis_manibus"] == ins_type]
        simulations_by_type_len_EDH.append((ins_type, len(subset_df)))
simulations_by_type_len_EDH = sorted(
    simulations_by_type_len_EDH, key=lambda x: x[1], reverse=True)
simulations_by_type_len_EDH
simulations_by_type_EDH = []
for ins_type_tup in simulations_by_type_len_EDH[:8]:
    subset_df = EDH_dated[EDH_dated["form_dis_manibus"]
                          == ins_type_tup[0]]
    simulations = tempun.timeblocks_from_randoms(
        subset_df, "random_dates", [-200, 600, 25])
    ins_type_N = len(subset_df)
    simulations_by_type_EDH.append([ins_type_tup[0], ins_type_N, simulations])
simulations_by_type_EDH = sorted(
    simulations_by_type_EDH, key=lambda x: x[1], reverse=True)
date_vars_by_instypes = []
for ins_type_tup in simulations_by_type_len_EDH[:10]:
    subset_df = EDH_dated[EDH_dated["form_dis_manibus"]
                          == ins_type_tup[0]]
    date_vars = []
    for n in range(100):
        date_vars.append(
            [date_var[n] for date_var in subset_df["random_dates"] if date_var != None])
    date_vars_by_instypes.append(date_vars)
```

```{python}
simulations_by_type_len_EDH
```

```{python}
# Figure 2
plt.style.use("seaborn-white")
plt.rcParams['figure.dpi'] = 300
plt.rcParams['font.size'] = 10
fig, ax = plt.subplots(figsize=(14, 6), tight_layout=True)
for ins_type_sims, color in zip(simulations_by_type_EDH, tab_colors_list[:len(simulations_by_type_EDH)]):
    tempun.plot_timeblocks_data(ins_type_sims[2], ax=ax, color=color)
  
    
ax.set_xlabel("Year", weight="bold")
ax.set_ylabel("Count", weight="bold")
ax.set_title(f"'Dis manibus' formula on inscriptions over time (EDH, n={len(EDH_dated)})", weight="bold")
markers = [plt.Line2D([0, 0], [0, 0], color=color, lw=4)
           for color in tab_colors_list[:len(simulations_by_type_EDH)]]
legend_labels_EDH = [tup[0] + " (n={})".format(str(tup[1])) for tup in simulations_by_type_EDH]
ax.legend(markers, legend_labels_EDH, numpoints=1,  
           title=f"Formula types (EDH n={len(EDH_dated)})", title_fontsize="large", bbox_to_anchor=(1, 1), loc='upper right')

plt.savefig('../figures/02_EDH_Typologies_comparison_time.png')
fig
```



## Periods 
```{python}
# periods definitions
periods = {  # to avoid overlaps, startdates are postponed by one year, when needed
    "2/2 1st c. BCE": {"startdate": -50, "enddate": 0, "duration": 50},
    "1/2 1st c. CE": {"startdate": 1, "enddate": 50,"duration": 50},
    "2/2 1st c. CE": {"startdate": -51, "enddate": 100, "duration": 50},
    "1/2 2nd c. CE": {"startdate": 101, "enddate": 150, "duration": 50},
    "2/2 2nd c. CE": {"startdate": 151, "enddate": 200, "duration": 50},
    "1/2 3rd c. CE": {"startdate": 201, "enddate": 250,"duration": 50},
    "2/2 3rd c. CE": {"startdate": 251, "enddate": 300,"duration": 50},
    "1/2 4th c. CE": {"startdate": 301, "enddate": 350,"duration": 50}
}
timeblocks_periods = [(periods[period]["startdate"],
                       periods[period]["enddate"],
                       periods[period]["duration"]) for period in periods]
timeblocks_periods
```

```{python}
def date_to_str(date):
    if date < 0:
        date = str(abs(date)) + " BC"
    else:
        date = "AD " + str(date)
    return date
periods_labels = []
for period in periods.keys():
    start = date_to_str(periods[period]["startdate"])
    end = date_to_str(periods[period]["enddate"])
    periods_labels.append(period + "\n({0}-{1})".format(start, end))
periods_labels
```

```{python}
# loading shapefile from Pleaides for the largest extent of the Roman Empire, AD 117
# source: https://raw.githubusercontent.com/pelagios/magis-pleiades-regions/main/pleiades-regions-magis-pelagios.geojson
pleiades_regions = gpd.read_file('../data/pleiades_regions.geojson', driver='GeoJSON')
RE_merged = pleiades_regions.unary_union
```

```{python}
def get_date_var(randoms):
    try:
        return randoms[0]
    except:
        return None
# selecting one random date out of the 1000 version
EDH_dated["date_var_1"] = EDH_dated["random_dates"].apply(get_date_var)
```

```{r}
# updating the values in existing r-object
py$EDH_dated -> EDH_dated
```

```{python}
# modifying coordinates in EDH to fit the script
# EDH_dated[['Longitude', 'Latitude']] = pd.DataFrame(EDH_dated.coordinates. tolist(), index=EDH_dated.index)
```

```{python}
EDH_dated_df_by_periods = []
for period in timeblocks_periods:
    EDH_dated_sample = EDH_dated[EDH_dated["date_var_1"].between(
        period[0], period[1])]
    # tranforming EDH as geodataframe
    EDH_dated_sample = EDH_dated_sample[EDH_dated_sample["latitude"].notnull()]
    EDH_dated_sample = gpd.GeoDataFrame(EDH_dated_sample, geometry=gpd.points_from_xy(EDH_dated_sample["longitude"], EDH_dated_sample["latitude"]))
    # selecting only those dated and within borders of the Empire (the largest extent in AD 117)
    EDH_dated_sample = EDH_dated_sample[EDH_dated_sample.within(RE_merged)]
    EDH_dated_df_by_periods.append(EDH_dated_sample)
```

```{python}
# Figure 3
# plot EDH inscriptions with location in 8 plots grouped by period
plt.style.use("seaborn-white")
plt.rcParams['figure.dpi'] = 300
plt.rcParams['font.size'] = 10
fig, axs  = plt.subplots(4, 2, figsize=(7, 7), tight_layout=True)
contexts_pct = {}
    
for df_edh, ax, period in zip(EDH_dated_df_by_periods, axs.ravel(), periods_labels):
    pleiades_regions.plot(ax=ax, color="lightgray")
    df_edh.plot(markersize=0.04, color="darkblue", ax=ax, alpha=0.2, label=len(df_edh))
    ax.set_title(period, fontsize=6)
    ax.set_axis_off()
    markers = [plt.Line2D([0,0],[0,0],color=color, marker=".", linestyle="") for color in ["darkblue", "red"]]
    legend_labels = ["EDH (n={0})".format(str(len(df_edh)))]
    
    ax.legend(markers, legend_labels, numpoints=1, bbox_to_anchor=(0.6, 1), loc='upper left', fontsize=5)
   
plt.tight_layout(pad=0)
plt.subplots_adjust(wspace=0.0, hspace=0.0)
fig.suptitle(f'Spatial extent of the epigraphic production by historic period', fontsize=8, fontweight="bold")
plt.savefig('../figures/03_EDH_Formulae_production_periods.png')
fig
```

# Combined two most common types as time slices

```{python}
dis_manibus = EDH_dated[EDH_dated["form_dis_manibus"] == "dis manibus"]
len(dis_manibus)
```

```{python}
diis_manibus = EDH_dated[EDH_dated["form_dis_manibus"] == "diis manibus"]
len(diis_manibus)
```

```{python}
dis_manibus_sac = EDH_dated[EDH_dated["form_dis_manibus"] == "dis manibus sacrum"]
len(dis_manibus_sac)
```
```{python}
diis_manibus_sac = EDH_dated[EDH_dated["form_dis_manibus"] == "diis manibus sacrum"]
len(diis_manibus_sac)
```


```{python}
EDH_dated_df_by_periods_dm = []
for period in timeblocks_periods:
    EDH_dated_sample_dm = dis_manibus[dis_manibus["date_var_1"].between(
        period[0], period[1])]
    # tranforming EDH as geodataframe
    EDH_dated_sample_dm = EDH_dated_sample_dm[EDH_dated_sample_dm["latitude"].notnull()]
    EDH_dated_sample_dm = gpd.GeoDataFrame(EDH_dated_sample_dm, geometry=gpd.points_from_xy(EDH_dated_sample_dm["longitude"], EDH_dated_sample_dm["latitude"]))
    # selecting only those dated and within borders of the Empire (the largest extent in AD 117)
    EDH_dated_sample_dm = EDH_dated_sample_dm[EDH_dated_sample_dm.within(RE_merged)]
    EDH_dated_df_by_periods_dm.append(EDH_dated_sample_dm)
```

```{python}
EDH_dated_df_by_periods_dm
```


```{python}
EDH_dated_df_by_periods_dms = []
for period in timeblocks_periods:
    EDH_dated_sample_dms = dis_manibus_sac[dis_manibus_sac["date_var_1"].between(
        period[0], period[1])]
    # tranforming EDH as geodataframe
    EDH_dated_sample_dms = EDH_dated_sample_dms[EDH_dated_sample_dms["latitude"].notnull()]
    EDH_dated_sample_dms = gpd.GeoDataFrame(EDH_dated_sample_dms, geometry=gpd.points_from_xy(EDH_dated_sample_dms["longitude"], EDH_dated_sample_dms["latitude"]))
    # selecting only those dated and within borders of the Empire (the largest extent in AD 117)
    EDH_dated_sample_dms = EDH_dated_sample_dms[EDH_dated_sample_dms.within(RE_merged)]
    EDH_dated_df_by_periods_dms.append(EDH_dated_sample_dms)
```

```{python}
EDH_dated_df_by_periods_dms
```


```{python}
# Figure 4
# plot EDH inscriptions with location in 8 plots grouped by period
plt.style.use("seaborn-white")
plt.rcParams['figure.dpi'] = 300
plt.rcParams['font.size'] = 10
fig, axs  = plt.subplots(4, 2, figsize=(7, 7), tight_layout=True)
contexts_pct = {}
    
for df_edh_dms, df_edh_dm, ax, period in zip(EDH_dated_df_by_periods_dms, EDH_dated_df_by_periods_dm, axs.ravel(), periods_labels):
    pleiades_regions.plot(ax=ax, color="lightgray")
    df_edh_dm.plot(markersize=0.04, color="darkblue", ax=ax, alpha=0.5, label=len(df_edh_dms))
    df_edh_dms.plot(markersize=0.04, color="red", ax=ax, alpha=0.5, label=len(df_edh_dm))
    ax.set_title(period, fontsize=6)
    ax.set_axis_off()
    markers = [plt.Line2D([0,0],[0,0],color=color, marker=".", linestyle="") for color in ["darkblue", "red"]]
    legend_labels = ["dis manibus (n={0})".format(str(len(df_edh_dm))), 
                     "dis manibus sacrum (n={0})".format(str(len(df_edh_dms)))]
    
    ax.legend(markers, legend_labels, numpoints=1, bbox_to_anchor=(0.6, 1), loc='upper left', fontsize=5)
   
plt.tight_layout(pad=0)
plt.subplots_adjust(wspace=0.0, hspace=0.0)
fig.suptitle(f'Spatial distribution of "dis manibus" formula by historic period (EDH dataset)', fontsize=8, fontweight="bold")
plt.savefig('../figures/04_EDH_Formulae_compared_production_periods.png')
fig
```



# Creating three snaphots in time

From simulated dates take 1-100, 101-200, 201-300 and then create a network.

```{r}
EDH_dated[80]
```

```{r}
EDH_1CAD<- EDH_dated %>% 
  select(id, longitude, latitude, type_of_inscription_clean, height_cm, width_cm, depth_cm, material_clean, type_of_monument_clean, province_label_clean, country_clean, findspot_ancient_clean, clean_text_conservative, clean_text_interpretive_word, clean_text_interpretive_word_lowercase, form_dis_manibus, random_dates, date_var_1) %>% 
  filter(date_var_1 > 0 & date_var_1 < 101) 

EDH_2CAD<- EDH_dated %>% 
  select(id, longitude, latitude, type_of_inscription_clean, height_cm, width_cm, depth_cm, material_clean, type_of_monument_clean, province_label_clean, country_clean, findspot_ancient_clean, clean_text_conservative, clean_text_interpretive_word, clean_text_interpretive_word_lowercase, form_dis_manibus, random_dates, date_var_1) %>%
  filter(date_var_1 > 100 & date_var_1 < 201)

EDH_3CAD<- EDH_dated %>% 
  select(id, longitude, latitude, type_of_inscription_clean, height_cm, width_cm, depth_cm, material_clean, type_of_monument_clean, province_label_clean, country_clean, findspot_ancient_clean, clean_text_conservative, clean_text_interpretive_word, clean_text_interpretive_word_lowercase, form_dis_manibus, random_dates, date_var_1) %>%
  filter(date_var_1 > 200 & date_var_1 < 301)
```

```{r}
# save the time sliced data locally
library(jsonlite)

EDH_1CADjson <- jsonlite::toJSON(EDH_1CAD, auto_unbox = TRUE, force = TRUE)
write(EDH_1CADjson, file="../data/EDH_1CAD.json")
EDH_2CADjson <- jsonlite::toJSON(EDH_2CAD, auto_unbox = TRUE)
write(EDH_2CADjson, file="../data/EDH_2CAD.json")
EDH_3CADjson <- jsonlite::toJSON(EDH_3CAD, auto_unbox = TRUE)
write(EDH_3CADjson, file="../data/EDH_3CAD.json")
```




# Clustering of formulae in three time slices

```{r, 1CAD}
# Damerau-Levenshtein method - allows for substitution, deletion, insertion and transposition of individual characters

dl_distance_1CAD<- stringdistmatrix(EDH_1CAD$form_dis_manibus, EDH_1CAD$form_dis_manibus, method= "dl")
table(dl_distance_1CAD)
dl_distance_1CAD


# renaming rows and columns
idnames <- unique(as.character(EDH_1CAD$id))
rownames(dl_distance_1CAD) <- idnames
colnames(dl_distance_1CAD) <- idnames

# Clustering the distance results in a dendrogram
hc_1CAD <- hclust(as.dist(dl_distance_1CAD), method = "complete")

plot(hc_1CAD, main ="Clustering of 'Dis Manibus' inscriptions in the 1st c. AD", xlab="Clusters")
rect.hclust(hc_1CAD, k=3)

```

```{r, 2CAD}
# Damerau-Levenshtein method - allows for substitution, deletion, insertion and transposition of individual characters

dl_distance_2CAD<- stringdistmatrix(EDH_2CAD$form_dis_manibus, EDH_2CAD$form_dis_manibus, method= "dl")
table(dl_distance_2CAD)
dl_distance_2CAD


# renaming rows and columns
idnames <- unique(as.character(EDH_2CAD$id))
rownames(dl_distance_2CAD) <- idnames
colnames(dl_distance_2CAD) <- idnames

# Clustering the distance results in a dendrogram
hc_2CAD <- hclust(as.dist(dl_distance_2CAD), method = "complete")

plot(hc_2CAD, main ="Clustering of 'Dis Manibus' inscriptions in the 2nd c. AD", xlab="Clusters")
rect.hclust(hc_2CAD, k=3)
```

```{r, 3CAD}
# Damerau-Levenshtein method - allows for substitution, deletion, insertion and transposition of individual characters

dl_distance_3CAD<- stringdistmatrix(EDH_3CAD$form_dis_manibus, EDH_3CAD$form_dis_manibus, method= "dl")
table(dl_distance_3CAD)
dl_distance_3CAD


# renaming rows and columns
idnames <- unique(as.character(EDH_3CAD$id))
rownames(dl_distance_3CAD) <- idnames
colnames(dl_distance_3CAD) <- idnames

# Clustering the distance results in a dendrogram
hc_3CAD <- hclust(as.dist(dl_distance_3CAD), method = "complete")

plot(hc_3CAD, main ="Clustering of 'Dis Manibus' inscriptions in the 3rd c. AD", xlab="Clusters")
rect.hclust(hc_3CAD, k=3)
```


## Three networks in time

https://yulab-smu.top/treedata-book/chapter4.html
```{r}
# convert 'hclust' to 'phylo' object
phylo_tree <- as.phylo(hc_1CAD)

# get edges
graph_edges <- phylo_tree$edge

# get graph from edge list
graph_net <- graph.edgelist(graph_edges)

# plot graph
plot(graph_net)
```


```{r}
dl_distance_1CADdf<- as.data.frame(dl_distance_1CAD)
dl_distance_2CADdf<- as.data.frame(dl_distance_2CAD)
dl_distance_3CADdf<- as.data.frame(dl_distance_3CAD)
```

```{r, fig.width=30}
dl_distance_1CADdf[1:3,1:3]

library(igraph)

#network1 <- graph_from_incidence_matrix(dl_distance_1CADdf, weighted=TRUE)
#plot(network1)
```
```{r}
#network2 <- graph_from_incidence_matrix(dl_distance_2CADdf, weighted=TRUE)
#plot(network2)

```

```{r}
#network3 <- graph_from_incidence_matrix(dl_distance_3CADdf, weighted=TRUE)
#plot(network3)
```

# TF-IDF for all DM inscriptions
