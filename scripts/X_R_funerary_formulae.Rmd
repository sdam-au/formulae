---
title: "`Dis manibus`in time"
author: 
- Petra Hermankova^[Aarhus University, Denmark, https://orcid.org/0000-0002-6349-0540]
date: "`r format(Sys.Date())`"
output:
  html_document:
    theme: united
    toc: yes
    toc_float: true
    number_sections: true
    toc_depth: 2
    df_print: paged
---

```{r, echo=FALSE}



library(tidyverse)
library(jsonlite)

```


# Setup

**Loading data from Sciencedata.dk**

```{r}
#list_json <- jsonlite::fromJSON("https://sciencedata.dk/public/b6b6afdb969d378b70929e86e58ad975/EDH_text_cleaned_2021-01-21.json")
#EDH <- as_tibble(list_json)
```

**Loading data locally**
```{r}
# this will work only if you have the dataset available locally
EDH <- jsonlite::fromJSON("../data/EDH_text_cleaned_2021-01-21.json")
#dir.create("../figures")
```

## Text preparation

Converting the text of inscriptions to lowercase
```{r}
EDH <- EDH %>% 
  mutate(clean_text_interpretive_word_lowercase = str_to_lower(EDH$clean_text_interpretive_word)) %>% 
  mutate(clean_text_conservative_lowercase = str_to_lower(EDH$clean_text_conservative))
```

## Preparation coordinates for mapping
```{r}
# preparation of coordinates
EDH<- EDH %>% 
  separate(col = coordinates, into = c("longitude", "latitude"), sep = ",")

EDH$latitude <- as.numeric(str_replace(EDH$latitude, pattern = "\\)", replacement=""))
EDH$longitude <- as.numeric(str_replace(EDH$longitude, pattern = "c\\(", replacement=""))
```


# Epigraphic formulae on funerary inscriptions

Inspired by > Bennett and Laurence 2020: The Local and the Global: the Use of Formulae in the Epitaphs at Ostia

The following formulae typically occurs on funerary inscriptions.

Canonic Versions:

D M - Dis Manibus (invocation of the underworld ancestral spirits/deities)
D M S - Dis Manibus Sacrum
V A - Vixit annos (formula stating how many years the deceased lived)
S T T L - Sit tibi terra levis (formula wishing the deceased: May the earth lie lightly on you)
H S E - Hic situs/sita est (formula introducing the deceased: here lies X)
B M - Bene merenti (formula praising the deceased)
IN AG IN FR - In Fronte ... In agros (formula specifying the extent of the burial plot)
L L P Q E - Libertis libertabusque posterisque eorum (formula for the freedmen and freedwomen and their descendants)
H M H N S - Hoc Monumentum Heredem Non Sequetur (formula prohibiting future use of the burial plot by heirs)
P M - Plus minus (formula relating to uncertain age: more or less)
O T B Q - Ossa tibi bene quiescant (formula wishing the deceased: may your bones rest well)


## Extracting inscriptions with for all *typical* variants of the formulae

```{r}
dms_regex <- "\\bdi{1,2}s manibus sacrum\\b"

dm_regex <- "\\bdi{1,2}s manibus\\b"

vixitannos_regex <- "\\bvixit ann[o|i]s\\b"

sittibi_regex <- "\\bsit tibi terra levis\\b"

hst_regex <- "\\bhic sita est|\\bhic situs est\\b"

benemer_regex <- "\\bbene merenti\\b"

ifig_regex <- "\\bin fronte\\b"

llpe_regex <- "\\blibertis libertabus"

hmhns_regex <- "\\bheredem non sequetur\\b"

pm_regex <- "\\bplus minus\\b"

otbq_regex <- "\\bossa tibi bene quiescant\\b"

```

Extracting the formulae specified by the regular expressions into individual comlumns.
```{r}

EDH$form_dm <- ifelse(grepl(dm_regex, EDH$clean_text_interpretive_word_lowercase, ignore.case = T),  str_extract(EDH$clean_text_interpretive_word_lowercase, dm_regex), NA)

EDH$form_dms <- ifelse(grepl(dms_regex, EDH$clean_text_interpretive_word_lowercase, ignore.case = T),  str_extract(EDH$clean_text_interpretive_word_lowercase, dms_regex), NA)

EDH$form_va <- ifelse(grepl(vixitannos_regex, EDH$clean_text_interpretive_word_lowercase, ignore.case = T),  str_extract(EDH$clean_text_interpretive_word_lowercase, vixitannos_regex), NA)

EDH$form_sttl <- ifelse(grepl(sittibi_regex, EDH$clean_text_interpretive_word_lowercase, ignore.case = T),  str_extract(EDH$clean_text_interpretive_word_lowercase, sittibi_regex), NA)

EDH$form_hst <- ifelse(grepl(hst_regex, EDH$clean_text_interpretive_word_lowercase, ignore.case = T),  str_extract(EDH$clean_text_interpretive_word_lowercase, hst_regex), NA)

EDH$form_bm <- ifelse(grepl(benemer_regex, EDH$clean_text_interpretive_word_lowercase, ignore.case = T),  str_extract(EDH$clean_text_interpretive_word_lowercase, benemer_regex), NA)

EDH$form_ifig <- ifelse(grepl(ifig_regex, EDH$clean_text_interpretive_word_lowercase, ignore.case = T),  str_extract(EDH$clean_text_interpretive_word_lowercase, ifig_regex), NA)

EDH$form_llps <- ifelse(grepl(llpe_regex, EDH$clean_text_interpretive_word_lowercase, ignore.case = T),  str_extract(EDH$clean_text_interpretive_word_lowercase, llpe_regex), NA)

EDH$form_hmhns <- ifelse(grepl(hmhns_regex, EDH$clean_text_interpretive_word_lowercase, ignore.case = T),  str_extract(EDH$clean_text_interpretive_word_lowercase, hmhns_regex), NA)

EDH$form_pm <- ifelse(grepl(pm_regex, EDH$clean_text_interpretive_word_lowercase, ignore.case = T),  str_extract(EDH$clean_text_interpretive_word_lowercase, pm_regex), NA)

EDH$form_obtq <- ifelse(grepl(otbq_regex, EDH$clean_text_interpretive_word_lowercase, ignore.case = T),  str_extract(EDH$clean_text_interpretive_word_lowercase, otbq_regex), NA)

```

Merging the formulas into one column by pivot longer function.
```{r}

EDH %>% 
  select(-formula_type, -name)

EDH<- EDH %>%
pivot_longer(
cols = starts_with("form_"),
values_to = "formula_type",
values_drop_na = TRUE
)

#Fixing hic situs est and hic sita est into one

EDH$formula_type <- ifelse(grepl("hic situs est|hic sita est", EDH$formula_type, ignore.case = T),  "hic sita/us est", EDH$formula_type)

#Fixing dis manibus and diis manibus est into one 

EDH$formula_type <- ifelse(grepl("diis|dis manibus\\z", EDH$formula_type, ignore.case = T),  "dis manibus", EDH$formula_type)

EDH$formula_type <- ifelse(grepl("dis manibus sacrum|diis manibus sacrum", EDH$formula_type, ignore.case = T),  "dis manibus sacrum", EDH$formula_type)

EDH$formula_type <- ifelse(grepl("vixit annis|annos", EDH$formula_type, ignore.case = T),  "vixit anno/is", EDH$formula_type)

EDH %>% 
  count(formula_type, sort=T)

```

## Subsetting only to funerary inscriptions
```{r}
#names(EDH)

EDHfun <- EDH %>% 
  select(id, formula_type, name, type_of_inscription_clean, type_of_monument_clean, material_clean, not_before, not_after, latitude, longitude, province_label_clean, clean_text_interpretive_word, clean_text_interpretive_word_lowercase, people) %>% 
  filter(type_of_inscription_clean == "epitaph")

write_rds(EDHfun, "../data/EDH_funerary.rds")
```

## Exploring formulae

```{r}
EDHfun %>% 
  count(formula_type, sort=T) %>% 
  mutate(ratio = round(n/(sum(n)/100),2))
```

### Province

#### Type of formula by province - frequence
```{r, fig.height=10, fig.width=10}
EDMfun_freq<- EDHfun %>% 
  #dplyr::filter(!is.na(formula_cat)) %>% 
  ggplot(aes(y=province_label_clean)) + 
  geom_bar(aes(fill=formula_type)) +
  #coord_cartesian(xlim=c(0,1700)) +
  theme_minimal() +
  theme(text = element_text(size=12)) +
  labs(y="Roman province", x="Formula", title= "Frequence of funerary formulae by province", subtitle = ggtitle(paste("n =", nrow(EDHfun), "funerary inscriptions (EDH)")))  
EDMfun_freq
ggsave("../figures/EDMfun_province_freq.png")

```

#### Ratio of formulae variants per province

NA - represents all inscriptions without any formula
```{r, fig.height=10}

form_form<- EDHfun %>% 
  select(formula_type, province_label_clean) %>% 
  count(formula_type, province_label_clean, sort=T)


EDHfun %>% 
  ggplot(aes(y=province_label_clean, fill=formula_type)) +
  geom_bar(position="fill") +
  theme_minimal() +
  theme(text = element_text(size=12)) +
  geom_vline(xintercept=c(0.25, 0.5, 0.75), linetype="dotted", color = "blue", size=0.8) + 
  labs(y="Roman province", x="Formula", title= "Ratio of funerary formulae by province", subtitle = ggtitle(paste("n =", nrow(EDHfun), "inscriptions (EDH)"))) 
  #geom_label(aes(label= form_dis_manibus)) +
  #geom_label(aes(label = form_dis_manibus), colour = "black", fontface = "bold", hjust = -0.1)
```

